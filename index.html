<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="4Sc0rP_X5SiwRFn4Nysc008ju4IMJ91hmHmEEeqdd3o" />
    <title>Agenda de Contatos Online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- RESET E CONFIGURAÇÕES GLOBAIS --- */
        :root {
            /* Paleta de Cores - Modo Claro */
            --bg-light: #F8F9FA; --surface-light: #FFFFFF; --text-primary-light: #212529; --text-secondary-light: #6C757D; --accent-light: #4C6EF5; --accent-hover-light: #3B5BDB; --danger-light: #E03131; --success-light: #2F9E44; --border-light: #DEE2E6; --submenu-bg-light: #F1F3F5;

            /* Paleta de Cores - Modo Escuro */
            --bg-dark: #121212; --surface-dark: #1E1E1E; --text-primary-dark: #E9ECEF; --text-secondary-dark: #AAB0B7; --accent-dark: #748FFC; --accent-hover-dark: #91A7FF; --danger-dark: #FF6B6B; --success-dark: #69DB7C; --border-dark: #363636; --submenu-bg-dark: #2C2E33;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* --- TEMAS --- */
        body.light-theme {
            background-color: var(--bg-light); color: var(--text-primary-light);
        }
       .light-theme .surface { background-color: var(--surface-light); }
       .light-theme .text-secondary { color: var(--text-secondary-light); }
       .light-theme .btn-primary { background-color: var(--accent-light); }
       .light-theme .btn-primary:hover { background-color: var(--accent-hover-light); }
       .light-theme .btn-danger { background-color: var(--danger-light); }
       .light-theme .btn-secondary { background-color: var(--text-secondary-light); color: white; }
       .light-theme .form-input,.light-theme .form-select { border: 1px solid var(--border-light); background-color: var(--surface-light); color: var(--text-primary-light); }
       .light-theme .contact-item, .light-theme .birthday-item, .light-theme .category-item { border-bottom: 1px solid var(--border-light); }
       .light-theme .contact-item:hover, .light-theme .birthday-item:hover, .light-theme .category-item:hover { background-color: var(--bg-light); }
       .light-theme .modal-content { background-color: var(--surface-light); }
       .light-theme .loader-spinner { border-top-color: var(--accent-light); }
       .light-theme .link { color: var(--accent-light); }
       .light-theme .success-message { color: var(--success-light); }
       .light-theme .category-tag { background-color: var(--bg-light); border: 1px solid var(--border-light); }
       .light-theme .category-filter-btn.active { background-color: var(--accent-light); color: white; }
       .light-theme .tag-input-suggestion { background-color: var(--surface-light); }
       .light-theme .tag-input-suggestion:hover { background-color: var(--bg-light); }
       .light-theme .password-toggle-icon { color: var(--text-secondary-light); }
       .light-theme #settings-submenu { background-color: var(--submenu-bg-light); }
       .light-theme .btn-submenu:hover { background-color: var(--border-light); color: var(--text-primary-light); }
       .light-theme .btn-icon { color: var(--text-secondary-light); }


        body.dark-theme {
            background-color: var(--bg-dark); color: var(--text-primary-dark);
        }
       .dark-theme .surface { background-color: var(--surface-dark); }
       .dark-theme .text-secondary { color: var(--text-secondary-dark); }
       .dark-theme .btn-primary { background-color: var(--accent-dark); }
       .dark-theme .btn-primary:hover { background-color: var(--accent-hover-dark); }
       .dark-theme .btn-danger { background-color: var(--danger-dark); }
       .dark-theme .btn-secondary { background-color: var(--text-secondary-dark); color: var(--surface-dark); }
       .dark-theme .form-input,.dark-theme .form-select { border: 1px solid var(--border-dark); background-color: var(--surface-dark); color: var(--text-primary-dark); }
       .dark-theme .contact-item, .dark-theme .birthday-item, .dark-theme .category-item { border-bottom: 1px solid var(--border-dark); }
       .dark-theme .contact-item:hover, .dark-theme .birthday-item:hover, .dark-theme .category-item:hover { background-color: var(--bg-dark); }
       .dark-theme .modal-content { background-color: var(--surface-dark); }
       .dark-theme .loader-spinner { border-top-color: var(--accent-dark); }
       .dark-theme .link { color: var(--accent-dark); }
       .dark-theme .success-message { color: var(--success-dark); }
       .dark-theme .category-tag { background-color: var(--bg-dark); border: 1px solid var(--border-dark); }
       .dark-theme .category-filter-btn.active { background-color: var(--accent-dark); color: var(--surface-dark); }
       .dark-theme .tag-input-suggestion { background-color: var(--surface-dark); }
       .dark-theme .tag-input-suggestion:hover { background-color: var(--bg-dark); }
       .dark-theme .password-toggle-icon { color: var(--text-secondary-dark); }
       .dark-theme #settings-submenu { background-color: var(--submenu-bg-dark); }
       .dark-theme .btn-submenu:hover { background-color: var(--border-dark); color: var(--text-primary-dark); }
       .dark-theme .btn-icon { color: var(--text-secondary-dark); }


        /* --- ESTRUTURA E LAYOUT --- */
       .hidden { display: none!important; }

        #auth-container {
            width: 100%;
            padding: 20px;
        }

       .auth-box {
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            margin: 0 auto;
        }
        .dark-theme .auth-box {
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        
        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        #app-view {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }

        #sidebar {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .light-theme #sidebar { border-right: 1px solid var(--border-light); }
        .dark-theme #sidebar { border-right: 1px solid var(--border-dark); }
        
        .sidebar-footer {
            padding: 16px;
            margin-top: auto;
            flex-shrink: 0;
        }
        .light-theme .sidebar-footer { border-top: 1px solid var(--border-light); }
        .dark-theme .sidebar-footer { border-top: 1px solid var(--border-dark); }

        #main-content {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* --- COMPONENTES --- */
       .header {
            padding: 16px;
            flex-shrink: 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .light-theme .header { border-bottom: 1px solid var(--border-light); }
        .dark-theme .header { border-bottom: 1px solid var(--border-dark); }

        .header > input { flex-grow: 1; }

       .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: white;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn svg {
            width: 1em;
            height: 1em;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
       .btn-block {
            display: block;
            width: 100%;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-icon {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-icon:hover {
            background-color: rgba(128, 128, 128, 0.1);
        }

        .btn-submenu {
            background-color: transparent;
            justify-content: flex-start;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        .light-theme .btn-submenu { color: var(--text-secondary-light); }
        .dark-theme .btn-submenu { color: var(--text-secondary-dark); }
        
        #settings-submenu {
            padding: 8px;
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-radius: 6px;
        }


       .form-group {
            margin-bottom: 16px;
            text-align: left;
        }
       .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }
       .form-input,.form-select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            font-size: 1rem;
        }
        .light-theme .form-input:focus, .light-theme .form-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-light);
        }
        .dark-theme .form-input:focus, .dark-theme .form-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-dark);
        }
        
        .password-wrapper {
            position: relative;
        }
        .password-wrapper .form-input {
            padding-right: 40px;
        }
        .password-toggle-icon {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
        }
        .password-toggle-icon svg {
            width: 20px;
            height: 20px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .form-row .form-group {
            flex-grow: 1;
        }

        .forgot-password-link {
            display: block;
            text-align: right;
            font-size: 0.85rem;
            margin-top: -8px;
            margin-bottom: 16px;
        }

        #contact-list, #birthday-list, #category-list {
            flex-grow: 1;
            overflow-y: auto;
        }
       .contact-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
       .light-theme .contact-item.active {
            background-color: var(--accent-light);
            color: white;
        }
       .dark-theme .contact-item.active { background-color: var(--accent-dark); color: var(--surface-dark); }
       .contact-item.active .text-secondary {
            color: rgba(255,255,255,0.8);
        }
       .dark-theme .contact-item.active .text-secondary {
            color: rgba(25, 25, 25, 0.8);
        }

       .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 12px;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        .light-theme .contact-avatar { background-color: var(--accent-light); }
        .dark-theme .contact-avatar { background-color: var(--accent-dark); }

        #contact-detail-view, #contact-form-view, #birthday-view, #category-view, #change-password-view {
            padding: 24px 32px;
        }

       .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

       .detail-field {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
       .detail-field strong {
            font-weight: 600;
            margin-bottom: 0;
            flex-shrink: 0;
       }
       .detail-field a {
            text-decoration: none;
       }
       .detail-field a:hover {
            text-decoration: underline;
       }
        .light-theme .detail-field a { color: var(--accent-light); }
        .dark-theme .detail-field a { color: var(--accent-dark); }
        
        .whatsapp-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #25D366;
            color: white;
            text-decoration: none;
            transition: transform 0.2s;
        }
        .whatsapp-btn:hover {
            transform: scale(1.1);
        }
        .whatsapp-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .birthday-item, .category-item {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .birthday-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .category-tag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        #category-filters {
            padding: 0 16px 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .category-filter-btn {
            padding: 4px 10px;
            font-size: 0.9rem;
            border: 1px solid;
            cursor: pointer;
            border-radius: 6px;
        }
        .light-theme .category-filter-btn {
             background-color: var(--bg-light);
             color: var(--text-primary-light);
             border-color: var(--border-light);
        }
        .dark-theme .category-filter-btn {
            background-color: var(--bg-dark);
            color: var(--text-primary-dark);
            border-color: var(--border-dark);
        }
        
        /* --- Componente Tag Input --- */
        .tag-input-wrapper {
            position: relative;
        }
        .tag-input-container {
            border: 1px solid;
            border-radius: 6px;
            padding: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        .light-theme .tag-input-container { border-color: var(--border-light); background-color: var(--surface-light); }
        .dark-theme .tag-input-container { border-color: var(--border-dark); background-color: var(--surface-dark); }
        
        .light-theme .tag-input-container:focus-within { box-shadow: 0 0 0 2px var(--accent-light); }
        .dark-theme .tag-input-container:focus-within { box-shadow: 0 0 0 2px var(--accent-dark); }

        .tag-input-tag {
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        .light-theme .tag-input-tag { background-color: var(--accent-light); }
        .dark-theme .tag-input-tag { background-color: var(--accent-dark); }
        
        .tag-input-remove {
            cursor: pointer;
            font-weight: bold;
        }
        
        .tag-input-field {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 5px;
            background-color: transparent;
        }
        .light-theme .tag-input-field { color: var(--text-primary-light); }
        .dark-theme .tag-input-field { color: var(--text-primary-dark); }

        .tag-input-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
        }
        .light-theme .tag-input-suggestions { border-color: var(--border-light); background-color: var(--surface-light); }
        .dark-theme .tag-input-suggestions { border-color: var(--border-dark); background-color: var(--surface-dark); }

        .tag-input-suggestion {
            padding: 10px;
            cursor: pointer;
        }
        .light-theme .tag-input-suggestion:hover { background-color: var(--bg-light); }
        .dark-theme .tag-input-suggestion:hover { background-color: var(--bg-dark); }


        #welcome-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            padding: 20px;
        }

        /* Loader e Modal */
       .loader-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
       .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

       .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
       .modal-content {
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
       .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .auth-toggle-link {
            margin-top: 24px;
            font-size: 0.9rem;
        }
        .auth-toggle-link a {
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
        }
        .auth-toggle-link a:hover {
            text-decoration: underline;
        }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            #app-view {
                grid-template-columns: 1fr;
            }
            #sidebar.has-selection {
                display: none;
            }
            #main-content {
                display: none;
            }
            #main-content.visible {
                display: flex;
            }
           .back-to-list-btn {
                display: block !important;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-container hidden">
        <div class="loader-spinner"></div>
    </div>

    <div id="auth-container">
        <div id="login-view" class="auth-box surface">
            <h1 class="app-title">AGENDA DE CONTATOS ONLINE</h1>
            <h2 id="auth-title">Bem-vindo(a)</h2>
            <p id="auth-subtitle" class="text-secondary" style="margin-bottom: 24px;">Faça login para gerenciar seus contatos.</p>
            <form id="auth-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-input" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" class="form-input" placeholder="Sua senha" required>
                        <span class="password-toggle-icon" data-target="password">
                            <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <svg class="eye-off-icon hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                        </span>
                    </div>
                </div>
                <div class="form-group hidden" id="confirm-password-group">
                    <label for="confirm-password">Confirmar Senha</label>
                     <div class="password-wrapper">
                        <input type="password" id="confirm-password" class="form-input" placeholder="Confirme sua senha">
                        <span class="password-toggle-icon" data-target="confirm-password">
                            <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            <svg class="eye-off-icon hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                        </span>
                    </div>
                </div>
                <a href="#" id="forgot-password-link" class="forgot-password-link link">Esqueceu sua senha?</a>
                <p id="auth-error" class="text-secondary" style="color: var(--danger-light); margin-bottom: 15px; min-height: 1.2em;"></p>
                <button id="auth-submit-btn" type="submit" class="btn btn-primary btn-block">Entrar</button>
            </form>
            <p id="login-toggle-text" class="auth-toggle-link text-secondary">
                Não tem uma conta? <a id="show-signup-link" class="link">Cadastre-se</a>
            </p>
             <p id="signup-toggle-text" class="auth-toggle-link text-secondary hidden">
                Já tem uma conta? <a id="show-login-link" class="link">Faça Login</a>
            </p>
        </div>

        <div id="reset-password-view" class="auth-box surface hidden">
            <h1 class="app-title">AGENDA DE CONTATOS ONLINE</h1>
            <h2>Redefinir Senha</h2>
            <p class="text-secondary" style="margin-bottom: 24px;">Insira seu email para receber o link de redefinição.</p>
            <form id="reset-password-form">
                 <div class="form-group">
                    <label for="reset-email">Email</label>
                    <input type="email" id="reset-email" class="form-input" placeholder="seu@email.com" required>
                </div>
                <p id="reset-message" class="text-secondary" style="margin-bottom: 15px; min-height: 1.2em;"></p>
                <button type="submit" class="btn btn-primary btn-block">Enviar Link</button>
            </form>
            <p class="auth-toggle-link text-secondary">
                Lembrou da senha? <a href="#" id="back-to-login-link" class="link">Voltar para o Login</a>
            </p>
        </div>
    </div>

    <div id="app-view" class="hidden">
        <aside id="sidebar">
            <div class="header">
                <input type="search" id="search-input" class="form-input" placeholder="Buscar por nome, email...">
                <button id="theme-toggle-btn" class="btn-icon" title="Alternar tema">
                    <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg id="theme-icon-moon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </div>
            <div id="category-filters" class="header" style="border: none; padding-top: 0;">
                </div>
            <div id="contact-list">
                </div>
            <div class="sidebar-footer">
                 <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px;">
                    <button id="add-contact-btn" class="btn btn-primary btn-block">+ Novo Contato</button>
                    <button id="show-birthday-btn" class="btn btn-block btn-secondary">Aniversários</button>
                    <div id="settings-menu">
                        <button id="settings-btn" class="btn btn-block btn-secondary" style="justify-content: space-between;">
                            <span>Configurações</span>
                            <svg id="settings-arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; transition: transform 0.3s;"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                        <div id="settings-submenu" class="hidden">
                            <button id="show-category-btn" class="btn btn-submenu">Gerir Categorias</button>
                            <button id="import-csv-btn" class="btn btn-submenu">Importar Contatos</button>
                            <button id="change-password-btn" class="btn btn-submenu">Alterar Senha</button>
                        </div>
                    </div>
                </div>
                <button id="logout-btn" class="btn btn-danger btn-block">Sair</button>
            </div>
        </aside>

        <main id="main-content">
            <div id="welcome-view">
                <h2>Selecione um contato</h2>
                <p class="text-secondary">Escolha um contato na lista à esquerda para ver os detalhes ou adicione um novo.</p>
            </div>

            <div id="contact-detail-view" class="hidden">
                <button class="btn back-to-list-btn hidden btn-secondary">← Voltar</button>
                <div class="detail-header">
                    <h2 id="detail-name"></h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="edit-contact-btn" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                            <span>Editar</span>
                        </button>
                        <button id="delete-contact-btn" class="btn btn-danger">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            <span>Excluir</span>
                        </button>
                    </div>
                </div>
                <div id="detail-categories-container" class="detail-field"><strong>Categorias:</strong></div>
                <div class="detail-field"><strong>Email:</strong> <a id="detail-email-link"><span id="detail-email"></span></a></div>
                <div id="detail-phone-fixed-container" class="detail-field"><strong>Fixo:</strong> <a id="detail-phone-fixed-link"><span id="detail-phone-fixed"></span></a></div>
                <div id="detail-phone-mobile-container" class="detail-field"><strong>Celular:</strong> <a id="detail-phone-mobile-link"><span id="detail-phone-mobile"></span></a></div>
                <div id="detail-address-container" class="detail-field"><strong>Endereço:</strong><span id="detail-address"></span></div>
                <div id="detail-anniversary-container" class="detail-field"><strong>Data de Aniversário:</strong> <span id="detail-anniversary"></span></div>
                <div id="detail-social-container" class="detail-field" style="flex-direction: column; align-items: flex-start;"></div>
                <div class="detail-field" style="flex-direction: column; align-items: flex-start;">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 4px;">
                        <strong>Notas:</strong>
                        <button id="optimize-notes-btn" class="btn btn-sm btn-secondary" title="Otimizar notas com IA">✨ Otimizar</button>
                    </div>
                    <p id="detail-notes" style="white-space: pre-wrap; width: 100%;"></p>
                </div>
            </div>

            <div id="contact-form-view" class="hidden">
                <button class="btn back-to-list-btn hidden btn-secondary">← Voltar</button>
                <h2 id="form-title">Adicionar Novo Contato</h2>
                <form id="contact-form" style="margin-top: 24px;">
                    <input type="hidden" id="contact-id">
                    <div class="form-group"><label for="form-firstName">Nome</label><input type="text" id="form-firstName" class="form-input" required></div>
                    <div class="form-group"><label for="form-lastName">Sobrenome</label><input type="text" id="form-lastName" class="form-input"></div>
                    
                    <div class="form-group tag-input-wrapper">
                        <label for="tag-input-field">Categorias</label>
                        <div id="tag-input-container" class="tag-input-container">
                            <input type="text" id="tag-input-field" class="tag-input-field" placeholder="Adicionar categoria...">
                        </div>
                        <div id="tag-input-suggestions" class="tag-input-suggestions hidden"></div>
                    </div>

                    <div class="form-group"><label for="form-email">Email</label><input type="email" id="form-email" class="form-input"></div>
                    <div class="form-group"><label for="form-phone-fixed">Telefone Fixo</label><input type="tel" id="form-phone-fixed" class="form-input" placeholder="(xx) xxxx-xxxx"></div>
                    <div class="form-group"><label for="form-phone-mobile">Telefone Celular</label><input type="tel" id="form-phone-mobile" class="form-input" placeholder="(xx) xxxxx-xxxx"></div>
                    
                    <div class="form-group"><label for="form-website">Website</label><input type="url" id="form-website" class="form-input" placeholder="https://..."></div>
                    <div class="form-group"><label for="form-linkedin">LinkedIn</label><input type="url" id="form-linkedin" class="form-input" placeholder="https://linkedin.com/in/..."></div>
                    <div class="form-group"><label for="form-facebook">Facebook</label><input type="url" id="form-facebook" class="form-input" placeholder="https://facebook.com/..."></div>
                    <div class="form-group"><label for="form-instagram">Instagram</label><input type="text" id="form-instagram" class="form-input" placeholder="@usuario"></div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 3;"><label for="form-street">Rua</label><input type="text" id="form-street" class="form-input" maxlength="40"></div>
                        <div class="form-group" style="flex: 1;"><label for="form-number">Número</label><input type="text" id="form-number" class="form-input" maxlength="6"></div>
                    </div>
                    <div class="form-group"><label for="form-complement">Complemento</label><input type="text" id="form-complement" class="form-input" maxlength="15"></div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;"><label for="form-city">Cidade</label><input type="text" id="form-city" class="form-input" maxlength="30"></div>
                        <div class="form-group" style="flex: 1;"><label for="form-state">Estado</label><select id="form-state" class="form-select"></select></div>
                        <div class="form-group" style="flex: 1;"><label for="form-zip">CEP</label><input type="text" id="form-zip" class="form-input" placeholder="xxxxx-xxx"></div>
                    </div>

                    <div class="form-group">
                        <label>Data de Aniversário</label>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1; margin-bottom: 0;"><label for="form-anniversary-day" class="hidden">Dia</label><select id="form-anniversary-day" class="form-select"></select></div>
                            <div class="form-group" style="flex: 2; margin-bottom: 0;"><label for="form-anniversary-month" class="hidden">Mês</label><select id="form-anniversary-month" class="form-select"></select></div>
                        </div>
                    </div>

                    <div class="form-group"><label for="form-notes">Notas</label><textarea id="form-notes" class="form-input" rows="4"></textarea></div>
                    <div style="display:flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">Salvar</button>
                        <button type="button" id="cancel-form-btn" class="btn btn-secondary">Cancelar</button>
                    </div>
                </form>
            </div>
            
            <div id="birthday-view" class="hidden">
                 <button class="btn back-to-list-btn hidden btn-secondary">← Voltar</button>
                 <div class="detail-header">
                    <h2 id="birthday-title">Aniversariantes do Mês</h2>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="month-filter" class="hidden">Filtrar por Mês:</label>
                        <select id="month-filter" class="form-select"></select>
                    </div>
                 </div>
                 <div id="birthday-list">
                    </div>
            </div>
            
            <div id="category-view" class="hidden">
                 <button class="btn back-to-list-btn hidden btn-secondary">← Voltar</button>
                 <div class="detail-header">
                    <h2>Gerir Categorias</h2>
                 </div>
                 <form id="add-category-form" style="display: flex; gap: 10px; margin-bottom: 24px;">
                    <input type="text" id="new-category-name" class="form-input" placeholder="Nova categoria" required>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                 </form>
                 <div id="category-list">
                    </div>
            </div>
            
            <div id="change-password-view" class="hidden">
                 <button class="btn back-to-list-btn hidden btn-secondary">← Voltar</button>
                 <div class="detail-header">
                    <h2>Alterar Senha</h2>
                 </div>
                 <form id="change-password-form" style="max-width: 500px;">
                    <div class="form-group">
                        <label for="current-password">Senha Atual</label>
                        <div class="password-wrapper">
                            <input type="password" id="current-password" class="form-input" required>
                            <span class="password-toggle-icon" data-target="current-password">
                                <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <svg class="eye-off-icon hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-password">Nova Senha</label>
                        <div class="password-wrapper">
                            <input type="password" id="new-password" class="form-input" required>
                             <span class="password-toggle-icon" data-target="new-password">
                                <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <svg class="eye-off-icon hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                            </span>
                        </div>
                    </div>
                     <p id="change-password-message" class="text-secondary" style="margin-bottom: 15px; min-height: 1.2em;"></p>
                    <button type="submit" class="btn btn-primary">Salvar Nova Senha</button>
                 </form>
            </div>

        </main>
    </div>

    <div id="delete-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="delete-modal-title">Confirmar Exclusão</h3>
            <p id="delete-modal-text">Você tem certeza que deseja excluir? Esta ação não pode ser desfeita.</p>
            <div class="modal-buttons">
                <button id="cancel-delete-btn" class="btn btn-secondary">Cancelar</button>
                <button id="confirm-delete-btn" class="btn btn-danger">Excluir</button>
            </div>
        </div>
    </div>
    
    <div id="gemini-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="gemini-modal-title" style="margin-bottom: 16px;">Assistente de Mensagem de Aniversário</h3>
            
            <div id="gemini-modal-initial-form">
                 <p class="text-secondary" style="margin-bottom: 16px;">Para gerar uma mensagem personalizada, forneça mais alguns detalhes sobre o seu relacionamento.</p>
                 <div class="form-group">
                    <label for="gemini-relationship">Qual é a sua proximidade?</label>
                    <select id="gemini-relationship" class="form-select">
                        <option value="um colega de trabalho">Colega de trabalho</option>
                        <option value="um amigo">Amigo(a)</option>
                        <option value="um amigo próximo">Amigo(a) próximo(a)</option>
                        <option value="um familiar">Familiar</option>
                        <option value="um cliente">Cliente</option>
                    </select>
                 </div>
                 <div class="form-group">
                    <label for="gemini-tone">Qual o tom da mensagem?</label>
                     <select id="gemini-tone" class="form-select">
                        <option value="profissional">Profissional</option>
                        <option value="descontraído">Descontraído</option>
                        <option value="divertido">Divertido</option>
                        <option value="caloroso">Caloroso</option>
                    </select>
                 </div>
                 <div class="form-group">
                    <label for="gemini-nickname">Apelido (opcional)</label>
                    <input type="text" id="gemini-nickname" class="form-input" placeholder="Ex: Zé, Mariazinha...">
                 </div>
                 <div class="modal-buttons">
                    <button type="button" id="gemini-modal-cancel-btn" class="btn btn-secondary">Cancelar</button>
                    <button id="gemini-modal-generate-btn" class="btn btn-primary">Gerar Mensagem</button>
                 </div>
            </div>

            <div id="gemini-modal-result" class="hidden">
                <div id="gemini-modal-loader" class="hidden" style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px;">
                    <div class="loader-spinner"></div>
                    <p class="text-secondary" style="margin-top: 10px;">A IA está construindo a sua mensagem...</p>
                </div>
                <textarea id="gemini-modal-textarea" class="form-input" rows="8"></textarea>
                <div class="modal-buttons">
                    <button id="gemini-modal-regenerate-btn" class="btn btn-secondary">Gerar Outra</button>
                    <button id="gemini-modal-copy-btn" class="btn btn-secondary">Copiar</button>
                    <button id="gemini-modal-send-btn" class="btn btn-primary">Enviar via WhatsApp</button>
                    <button id="gemini-modal-close-btn" class="btn btn-secondary">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="import-modal" class="modal hidden">
        <div class="modal-content">
            <h3 style="margin-bottom: 16px;">Importar Contatos de CSV</h3>
            <p class="text-secondary" style="margin-bottom: 16px; font-size: 0.9rem;">Selecione um arquivo .csv com os cabeçalhos das colunas exatamente nesta ordem: <code>primeiroNome,sobrenome,email,celular,telefoneFixo</code></p>
            <input type="file" id="csv-file-input" class="form-input" accept=".csv">
            <p id="import-status" class="text-secondary" style="margin-top: 16px; min-height: 1.2em;"></p>
            <div class="modal-buttons">
                <button id="import-cancel-btn" class="btn btn-secondary">Cancelar</button>
                <button id="import-start-btn" class="btn btn-primary">Importar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script type="module">
        // --- IMPORTAÇÕES DO FIREBASE (SDK MODULAR v9) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getFunctions, httpsCallable, connectFunctionsEmulator } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-functions.js";
        import { connectAuthEmulator } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCA8fr19Wvea4vnnZKhmDyQHe5LsSIBNzM",
            authDomain: "app-contatos-final.firebaseapp.com",
            projectId: "app-contatos-final",
            storageBucket: "app-contatos-final.appspot.com",
            messagingSenderId: "983365993269",
            appId: "1:983365993269:web:d23db1d384c8c97a68027c"
        };

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        auth.languageCode = 'pt-BR';
        const db = getFirestore(app);
        const functions = getFunctions(app);
        let contactsCollection;
        let categoriesCollection;
        let unsubscribeContacts = null;
        let unsubscribeCategories = null;

        const callGeminiFunction = httpsCallable(functions, 'callGemini');

        // --- CONECTAR AOS EMULADORES SE ESTIVER EM AMBIENTE LOCAL ---
        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
            console.log("Conectando aos emuladores locais...");
            connectAuthEmulator(auth, "http://localhost:9099");
            connectFirestoreEmulator(db, 'localhost', 8080);
            connectFunctionsEmulator(functions, "localhost", 5001);
        }


        // --- ESTADO DA APLICAÇÃO ---
        let contactsCache = [];
        let categoriesCache = [];
        let currentContactId = null;
        let currentFilter = '';
        let currentCategoryFilter = 'all';
        let isLoginMode = true;
        let selectedBirthdayMonth = new Date().getMonth() + 1;
        let itemToDelete = { id: null, type: null };
        let selectedCategoriesForForm = new Set();
        let currentContactForGemini = null;
        let lastGeminiPrompt = '';

        // --- REFERÊNCIAS AO DOM ---
        const loader = document.getElementById('loader');
        const authContainer = document.getElementById('auth-container');
        const appView = document.getElementById('app-view');
        const logoutBtn = document.getElementById('logout-btn');
        const contactList = document.getElementById('contact-list');
        const searchInput = document.getElementById('search-input');
        const addContactBtn = document.getElementById('add-contact-btn');
        const geminiModal = document.getElementById('gemini-modal');
        const geminiModalGenerateBtn = document.getElementById('gemini-modal-generate-btn');
        const geminiModalCancelBtn = document.getElementById('gemini-modal-cancel-btn'); // Referência adicionada
        const geminiModalCloseBtn = document.getElementById('gemini-modal-close-btn');
        
        // ... (outras referências ao DOM permanecem as mesmas)
        const loginView = document.getElementById('login-view');
        const resetPasswordView = document.getElementById('reset-password-view');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const confirmPasswordGroup = document.getElementById('confirm-password-group');
        const showSignupLink = document.getElementById('show-signup-link');
        const showLoginLink = document.getElementById('show-login-link');
        const loginToggleText = document.getElementById('login-toggle-text');
        const signupToggleText = document.getElementById('signup-toggle-text');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const backToLoginLink = document.getElementById('back-to-login-link');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const resetMessage = document.getElementById('reset-message');
        const categoryFiltersContainer = document.getElementById('category-filters');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const welcomeView = document.getElementById('welcome-view');
        const detailView = document.getElementById('contact-detail-view');
        const formView = document.getElementById('contact-form-view');
        const birthdayView = document.getElementById('birthday-view');
        const categoryView = document.getElementById('category-view');
        const changePasswordView = document.getElementById('change-password-view');
        const showBirthdayBtn = document.getElementById('show-birthday-btn');
        const showCategoryBtn = document.getElementById('show-category-btn');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const contactForm = document.getElementById('contact-form');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const editContactBtn = document.getElementById('edit-contact-btn');
        const deleteContactBtn = document.getElementById('delete-contact-btn');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const deleteModalText = document.getElementById('delete-modal-text');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const birthdayList = document.getElementById('birthday-list');
        const monthFilter = document.getElementById('month-filter');
        const optimizeNotesBtn = document.getElementById('optimize-notes-btn');
        const categoryList = document.getElementById('category-list');
        const addCategoryForm = document.getElementById('add-category-form');
        const newCategoryNameInput = document.getElementById('new-category-name');
        const tagInputContainer = document.getElementById('tag-input-container');
        const tagInputField = document.getElementById('tag-input-field');
        const tagInputSuggestions = document.getElementById('tag-input-suggestions');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsSubmenu = document.getElementById('settings-submenu');
        const settingsArrow = document.getElementById('settings-arrow');
        const changePasswordForm = document.getElementById('change-password-form');
        const changePasswordMessage = document.getElementById('change-password-message');
        const geminiModalInitialForm = document.getElementById('gemini-modal-initial-form');
        const geminiModalResult = document.getElementById('gemini-modal-result');
        const geminiModalLoader = document.getElementById('gemini-modal-loader');
        const geminiModalTextarea = document.getElementById('gemini-modal-textarea');
        const geminiModalRegenerateBtn = document.getElementById('gemini-modal-regenerate-btn');
        const geminiModalCopyBtn = document.getElementById('gemini-modal-copy-btn');
        const geminiModalSendBtn = document.getElementById('gemini-modal-send-btn');
        const importModal = document.getElementById('import-modal');
        const importCancelBtn = document.getElementById('import-cancel-btn');
        const importStartBtn = document.getElementById('import-start-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const importStatus = document.getElementById('import-status');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIconSun = document.getElementById('theme-icon-sun');
        const themeIconMoon = document.getElementById('theme-icon-moon');


        // --- FUNÇÕES AUXILIARES ---
        const showLoader = () => loader.classList.remove('hidden');
        const hideLoader = () => loader.classList.add('hidden');

        const showMainContentView = (view) => {
            [welcomeView, detailView, formView, birthdayView, categoryView, changePasswordView].forEach(v => v.classList.add('hidden'));
            if (view) view.classList.remove('hidden');

            // Lógica de responsividade: só alterna as visualizações em telas pequenas se não for a tela de boas-vindas
            if (window.innerWidth <= 768 && view !== welcomeView) {
                mainContent.classList.add('visible');
                sidebar.classList.add('has-selection');
            }
        };

        const hideMainContentView = () => {
             if (window.innerWidth <= 768) {
                mainContent.classList.remove('visible');
                sidebar.classList.remove('has-selection');
            }
            currentContactId = null;
            renderContactList();
        }

        const getAuthErrorMessage = (errorCode) => {
            const messages = {
                'auth/invalid-email': 'Formato de email inválido.',
                'auth/user-not-found': 'Nenhuma conta encontrada com este email.',
                'auth/wrong-password': 'Email ou senha incorretos.',
                'auth/email-already-in-use': 'Este email já está em uso.',
                'auth/weak-password': 'A senha deve ter pelo menos 6 caracteres.'
            };
            return messages[errorCode] || 'Ocorreu um erro. Tente novamente.';
        }
        
        const applyPhoneMask = (event) => {
            let value = event.target.value.replace(/\D/g, '');
            value = value.substring(0, 11);
            if (value.length > 10) value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
            else if (value.length > 6) value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            else if (value.length > 2) value = value.replace(/^(\d{2})(\d*)/, '($1) $2');
            event.target.value = value;
        };
        
        const applyCepMask = (event) => {
            let value = event.target.value.replace(/\D/g, '').substring(0, 8);
            event.target.value = value.replace(/^(\d{5})(\d)/, '$1-$2');
        };
        
        const populateStates = () => {
            const states = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];
            const select = document.getElementById('form-state');
            select.innerHTML = '<option value="">Selecione...</option>' + states.map(s => `<option value="${s}">${s}</option>`).join('');
        };
        
        const populateAnniversarySelectors = () => {
            const daySelect = document.getElementById('form-anniversary-day');
            const monthSelect = document.getElementById('form-anniversary-month');
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            daySelect.innerHTML = '<option value="">Dia</option>' + Array.from({length: 31}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('');
            monthSelect.innerHTML = '<option value="">Mês</option>' + months.map((m, i) => `<option value="${i+1}">${m}</option>`).join('');
        };
        
        const populateMonthFilter = () => {
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            monthFilter.innerHTML = months.map((m, i) => `<option value="${i+1}">${m}</option>`).join('');
            monthFilter.value = new Date().getMonth() + 1;
        };

        // --- LÓGICA DE AUTENTICAÇÃO ---
        const toggleAuthMode = (login) => {
            isLoginMode = login;
            authForm.reset();
            authError.textContent = '';
            authTitle.textContent = isLoginMode ? 'Bem-vindo(a)' : 'Crie sua Conta';
            authSubtitle.textContent = isLoginMode ? 'Faça login para continuar.' : 'É rápido e fácil.';
            authSubmitBtn.textContent = isLoginMode ? 'Entrar' : 'Cadastrar';
            confirmPasswordGroup.classList.toggle('hidden', isLoginMode);
            loginToggleText.classList.toggle('hidden', !isLoginMode);
            signupToggleText.classList.toggle('hidden', isLoginMode);
            forgotPasswordLink.classList.toggle('hidden', !isLoginMode);
        };

        showSignupLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthMode(false); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthMode(true); });
        
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginView.classList.add('hidden');
            resetPasswordView.classList.remove('hidden');
        });

        backToLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            resetPasswordView.classList.add('hidden');
            loginView.classList.remove('hidden');
            resetMessage.textContent = '';
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                authContainer.classList.add('hidden');
                appView.classList.remove('hidden');
                contactsCollection = collection(db, 'users', user.uid, 'contacts');
                categoriesCollection = collection(db, 'users', user.uid, 'categories');
                attachFirestoreListener();
                // No desktop, mostra a welcome view. No mobile, a lógica de CSS/JS já vai mostrar a lista.
                if (window.innerWidth > 768) {
                    showMainContentView(welcomeView);
                } else {
                    // Garante que no mobile a view principal fique oculta para mostrar a lista.
                    hideMainContentView();
                }
            } else {
                authContainer.classList.remove('hidden');
                appView.classList.add('hidden');
                if (unsubscribeContacts) unsubscribeContacts();
                if (unsubscribeCategories) unsubscribeCategories();
                contactsCache = [];
                categoriesCache = [];
                renderContactList();
                renderCategoryFilters();
            }
            hideLoader();
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            authError.textContent = '';
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const confirmPassword = document.getElementById('confirm-password').value;
                    if (password !== confirmPassword) throw { code: 'auth/password-mismatch' };
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                authError.textContent = getAuthErrorMessage(error.code) || 'As senhas não coincidem.';
            } finally {
                hideLoader();
            }
        });
        
        resetPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            resetMessage.textContent = '';
            resetMessage.classList.remove('success-message');
            try {
                await sendPasswordResetEmail(auth, document.getElementById('reset-email').value);
                resetMessage.textContent = 'Link de redefinição enviado para o seu email.';
                resetMessage.classList.add('success-message');
            } catch (error) {
                resetMessage.textContent = getAuthErrorMessage(error.code);
                resetMessage.classList.remove('success-message');
            } finally {
                hideLoader();
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- LÓGICA DE RENDERIZAÇÃO ---
        const createAndAppend = (parent, tag, { classes = [], text = '', id = '' } = {}) => {
            const el = document.createElement(tag);
            if (classes.length) el.classList.add(...classes);
            if (text) el.textContent = text;
            if (id) el.id = id;
            parent.appendChild(el);
            return el;
        };

        const renderContactList = () => {
            contactList.innerHTML = '';
            const filteredContacts = contactsCache.filter(contact => {
                const categoryMatch = currentCategoryFilter === 'all' || (contact.data.categories && contact.data.categories.includes(currentCategoryFilter));
                if (!categoryMatch) return false;
                const searchTerm = currentFilter.toLowerCase();
                if (!searchTerm) return true;
                const fullName = `${contact.data.firstName || ''} ${contact.data.lastName || ''}`.toLowerCase();
                const email = (contact.data.email || '').toLowerCase();
                return fullName.includes(searchTerm) || email.includes(searchTerm);
            }).sort((a, b) => (a.data.firstName || '').localeCompare(b.data.firstName || ''));

            if (filteredContacts.length === 0) {
                contactList.innerHTML = `<p style="padding: 16px;" class="text-secondary">${currentFilter ? 'Nenhum contato encontrado.' : 'Sua lista de contatos está vazia.'}</p>`;
                return;
            }

            filteredContacts.forEach(contact => {
                const item = createAndAppend(contactList, 'div', { classes: ['contact-item'] });
                item.dataset.id = contact.id;
                if (contact.id === currentContactId) item.classList.add('active');
                const name = `${contact.data.firstName || ''} ${contact.data.lastName || ''}`.trim();
                createAndAppend(item, 'div', { classes: ['contact-avatar'], text: name ? name.charAt(0) : '?' });
                const infoDiv = createAndAppend(item, 'div');
                createAndAppend(infoDiv, 'div', { text: name || 'Sem nome', classes: ['contact-name'] }).style.fontWeight = '500';
                createAndAppend(infoDiv, 'div', { text: contact.data.email || '', classes: ['text-secondary', 'contact-email'] }).style.fontSize = '0.9rem';
                item.addEventListener('click', () => showContactDetails(contact.id));
            });
        };
        
        const renderCategoryFilters = () => {
            categoryFiltersContainer.innerHTML = '';
            const allBtn = createAndAppend(categoryFiltersContainer, 'button', { text: 'Todos', classes: ['btn', 'category-filter-btn'] });
            if(currentCategoryFilter === 'all') allBtn.classList.add('active');
            allBtn.addEventListener('click', () => {
                currentCategoryFilter = 'all';
                renderCategoryFilters();
                renderContactList();
            });

            categoriesCache.sort((a, b) => a.data.name.localeCompare(b.data.name)).forEach(category => {
                const btn = createAndAppend(categoryFiltersContainer, 'button', { text: category.data.name, classes: ['btn', 'category-filter-btn'] });
                if(currentCategoryFilter === category.data.name) btn.classList.add('active');
                btn.addEventListener('click', () => {
                    currentCategoryFilter = category.data.name;
                    renderCategoryFilters();
                    renderContactList();
                });
            });
        };
        
        const renderBirthdayList = () => {
            birthdayList.innerHTML = '';
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('birthday-title').textContent = `Aniversariantes de ${monthNames[selectedBirthdayMonth - 1]}`;

            const birthdayContacts = contactsCache
                .filter(c => c.data.anniversary?.month === selectedBirthdayMonth)
                .sort((a, b) => (a.data.anniversary.day || 0) - (b.data.anniversary.day || 0));

            if (birthdayContacts.length === 0) {
                birthdayList.innerHTML = `<p class="text-secondary" style="padding: 16px;">Nenhum aniversariante em ${monthNames[selectedBirthdayMonth - 1]}.</p>`;
                return;
            }

            birthdayContacts.forEach(contact => {
                const item = createAndAppend(birthdayList, 'div', { classes: ['birthday-item'] });
                const infoDiv = createAndAppend(item, 'div');
                const name = `${contact.data.firstName || ''} ${contact.data.lastName || ''}`.trim();
                createAndAppend(infoDiv, 'div', { text: name, classes: ['contact-name'] }).style.fontWeight = '500';
                createAndAppend(infoDiv, 'div', { text: `Dia ${contact.data.anniversary.day}`, classes: ['text-secondary'] }).style.fontSize = '0.9rem';
                
                if (contact.data.phone?.mobile) {
                    const actionsDiv = createAndAppend(item, 'div', { classes: ['birthday-item-actions'] });
                    const generateBtn = createAndAppend(actionsDiv, 'button', { text: '✨ Gerar Mensagem', classes: ['btn', 'btn-sm', 'btn-secondary', 'generate-msg-btn'] });
                    generateBtn.dataset.contactId = contact.id;
                    const whatsappLink = createAndAppend(actionsDiv, 'a', { classes: ['whatsapp-btn'] });
                    whatsappLink.href = `https://wa.me/55${contact.data.phone.mobile.replace(/\D/g, '')}?text=Feliz%20aniversário!`;
                    whatsappLink.target = '_blank';
                    whatsappLink.title = 'Enviar mensagem no WhatsApp';
                    whatsappLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413C24 18.667 18.664 24 12.107 24h-.004c-1.963 0-3.898-.523-5.574-1.454l-6.341 1.688zM12.107 2.109c-5.468 0-9.908 4.44-9.908 9.908 0 2.098.631 4.062 1.735 5.748l-.926 3.385 3.468-.919c1.64.923 3.492 1.419 5.438 1.419h.004c5.468 0 9.908-4.44 9.908-9.908s-4.44-9.908-9.908-9.908zm4.717 11.382c-.272-.136-1.606-.79-1.855-.878-.247-.088-.427-.136-.607.136-.18.272-.703.878-.863 1.054-.16.176-.32.198-.6.062-.28-.136-1.187-.44-2.258-1.384-1.071-.944-1.792-2.108-2.096-2.46-.303-.352-.027-.55.11-.703.124-.136.272-.352.408-.528.136-.176.18-.295.272-.493.09-.198.045-.378-.023-.514-.068-.136-.607-1.455-.832-1.98-.225-.525-.45-.45-.62-.458-.17-.008-.37-.01-.55-.01-.18 0-.45.068-.68.342-.23.272-.878.863-.878 2.108s.898 2.44 1.018 2.616c.12.176 1.74 2.662 4.22 3.728 2.48.996 2.48 1.58 2.92 1.556.44-.023 1.606-.656 1.83-1.29.225-.63.225-1.162.16-1.29-.068-.136-.247-.204-.52-.34z"/></svg>`;
                }
            });
        };
        
        const renderCategoryList = () => {
            categoryList.innerHTML = '';
            if (categoriesCache.length === 0) {
                categoryList.innerHTML = `<p class="text-secondary">Nenhuma categoria cadastrada.</p>`;
                return;
            }
            categoriesCache.sort((a,b) => a.data.name.localeCompare(b.data.name)).forEach(category => {
                const item = createAndAppend(categoryList, 'div', { classes: ['category-item'] });
                createAndAppend(item, 'span', { text: category.data.name });
                const deleteBtn = createAndAppend(item, 'button', { text: 'Excluir', classes: ['btn', 'btn-danger', 'btn-sm', 'delete-category-btn'] });
                deleteBtn.dataset.id = category.id;
            });
        };

        // --- LÓGICA DO FIRESTORE (CRUD) ---
        const attachFirestoreListener = () => {
            if (unsubscribeContacts) unsubscribeContacts();
            if (unsubscribeCategories) unsubscribeCategories();
            unsubscribeContacts = onSnapshot(contactsCollection, snapshot => {
                contactsCache = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderContactList();
                if (document.getElementById('birthday-view').classList.contains('hidden') === false) renderBirthdayList();
                hideLoader();
            }, error => { console.error("Erro ao ouvir contatos:", error); hideLoader(); });
            unsubscribeCategories = onSnapshot(categoriesCollection, snapshot => {
                categoriesCache = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderCategoryFilters();
                renderCategoryList();
            }, error => { console.error("Erro ao ouvir categorias:", error); });
        };

        const saveContact = async (id, data) => {
            showLoader();
            try {
                if (id) {
                    await updateDoc(doc(contactsCollection, id), data);
                    showContactDetails(id);
                } else {
                    const docRef = await addDoc(contactsCollection, data);
                    showContactDetails(docRef.id);
                }
            } catch (error) {
                console.error("Erro ao salvar contato: ", error);
                alert("Falha ao salvar o contato.");
            } finally {
                hideLoader();
            }
        };

        const deleteItem = async () => {
            if (!itemToDelete.id || !itemToDelete.type) return;
            showLoader();
            try {
                const collectionRef = itemToDelete.type === 'contact' ? contactsCollection : categoriesCollection;
                await deleteDoc(doc(collectionRef, itemToDelete.id));
                if (itemToDelete.type === 'contact') {
                    currentContactId = null;
                    showMainContentView(welcomeView);
                }
            } catch (error) {
                console.error(`Erro ao excluir ${itemToDelete.type}:`, error);
                alert(`Falha ao excluir o item.`);
            } finally {
                itemToDelete = { id: null, type: null };
                deleteModal.classList.add('hidden');
                hideLoader();
            }
        };

        // --- MANIPULAÇÃO DE EVENTOS DA UI ---
        searchInput.addEventListener('input', (e) => {
            currentFilter = e.target.value;
            renderContactList();
        });

        const showContactDetails = (id) => {
            const contactWrapper = contactsCache.find(c => c.id === id);
            if (!contactWrapper) return;
            const contact = contactWrapper.data;
            currentContactId = id;
            renderContactList();

            document.getElementById('detail-name').textContent = `${contact.firstName || ''} ${contact.lastName || ''}`.trim();
            
            const categoriesContainer = document.getElementById('detail-categories-container');
            categoriesContainer.innerHTML = '<strong>Categorias:</strong>';
            if(contact.categories && contact.categories.length > 0) {
                contact.categories.forEach(categoryName => createAndAppend(categoriesContainer, 'span', { classes: ['category-tag'], text: categoryName }));
                categoriesContainer.classList.remove('hidden');
            } else {
                categoriesContainer.classList.add('hidden');
            }

            document.getElementById('detail-email').textContent = contact.email || 'Não informado';
            document.getElementById('detail-email-link').href = contact.email ? `mailto:${contact.email}` : '#';

            const setupDetailField = (containerId, linkId, spanId, value, linkPrefix) => {
                const container = document.getElementById(containerId);
                if (value) {
                    document.getElementById(spanId).textContent = value;
                    document.getElementById(linkId).href = `${linkPrefix}${value.replace(/\D/g, '')}`;
                    container.classList.remove('hidden');
                    return true;
                }
                container.classList.add('hidden');
                return false;
            };

            const mobileVisible = setupDetailField('detail-phone-mobile-container', 'detail-phone-mobile-link', 'detail-phone-mobile', contact.phone?.mobile, 'tel:');
            setupDetailField('detail-phone-fixed-container', 'detail-phone-fixed-link', 'detail-phone-fixed', contact.phone?.fixed, 'tel:');

            const phoneMobileContainer = document.getElementById('detail-phone-mobile-container');
            phoneMobileContainer.querySelector('.whatsapp-btn')?.remove();
            if (mobileVisible) {
                const whatsappLink = createAndAppend(phoneMobileContainer, 'a', { classes: ['whatsapp-btn'] });
                whatsappLink.href = `https://wa.me/55${contact.phone.mobile.replace(/\D/g, '')}`;
                whatsappLink.target = '_blank';
                whatsappLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413C24 18.667 18.664 24 12.107 24h-.004c-1.963 0-3.898-.523-5.574-1.454l-6.341 1.688zM12.107 2.109c-5.468 0-9.908 4.44-9.908 9.908 0 2.098.631 4.062 1.735 5.748l-.926 3.385 3.468-.919c1.64.923 3.492 1.419 5.438 1.419h.004c5.468 0 9.908-4.44 9.908-9.908s-4.44-9.908-9.908-9.908zm4.717 11.382c-.272-.136-1.606-.79-1.855-.878-.247-.088-.427-.136-.607.136-.18.272-.703.878-.863 1.054-.16.176-.32.198-.6.062-.28-.136-1.187-.44-2.258-1.384-1.071-.944-1.792-2.108-2.096-2.46-.303-.352-.027-.55.11-.703.124-.136.272-.352.408-.528.136-.176.18-.295.272-.493.09-.198.045-.378-.023-.514-.068-.136-.607-1.455-.832-1.98-.225-.525-.45-.45-.62-.458-.17-.008-.37-.01-.55-.01-.18 0-.45.068-.68.342-.23.272-.878.863-.878 2.108s.898 2.44 1.018 2.616c.12.176 1.74 2.662 4.22 3.728 2.48.996 2.48 1.58 2.92 1.556.44-.023 1.606-.656 1.83-1.29.225-.63.225-1.162.16-1.29-.068-.136-.247-.204-.52-.34z"/></svg>`;
            }

            const addressContainer = document.getElementById('detail-address-container');
            const addressSpan = document.getElementById('detail-address');
            const { street, number, complement, city, state, zip } = contact.address || {};
            const addressParts = [street && number ? `${street}, ${number}` : street, complement, city, state, zip].filter(Boolean);
            addressSpan.textContent = addressParts.join(' - ');
            addressContainer.classList.toggle('hidden', addressParts.length === 0);

            const anniversaryContainer = document.getElementById('detail-anniversary-container');
            const anniversarySpan = document.getElementById('detail-anniversary');
            if (contact.anniversary?.day && contact.anniversary?.month) {
                const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                anniversarySpan.textContent = `${contact.anniversary.day} de ${monthNames[contact.anniversary.month - 1]}`;
                anniversaryContainer.classList.remove('hidden');
            } else {
                anniversaryContainer.classList.add('hidden');
            }
            
            const socialContainer = document.getElementById('detail-social-container');
            socialContainer.innerHTML = '<strong>Redes Sociais:</strong>';
            let hasSocial = false;
            const socialLinks = [
                { key: 'website', url: contact.social?.website, text: 'Website' },
                { key: 'linkedin', url: contact.social?.linkedin, text: 'LinkedIn' },
                { key: 'facebook', url: contact.social?.facebook, text: 'Facebook' },
                { key: 'instagram', url: contact.social?.instagram, text: 'Instagram' }
            ];
            socialLinks.forEach(link => {
                if(link.url) {
                    hasSocial = true;
                    const linkDiv = createAndAppend(socialContainer, 'div');
                    linkDiv.style.marginLeft = '10px';
                    const a = createAndAppend(linkDiv, 'a', { text: `${link.text}: ${link.url}` });
                    a.href = link.key === 'instagram' ? `https://instagram.com/${link.url.replace('@','')}` : link.url;
                    a.target = '_blank';
                }
            });
            socialContainer.classList.toggle('hidden', !hasSocial);

            document.getElementById('detail-notes').textContent = contact.notes || 'Nenhuma nota.';
            showMainContentView(detailView);
        };

        const showContactForm = (contactId = null) => {
            contactForm.reset();
            document.getElementById('contact-id').value = '';
            selectedCategoriesForForm.clear();
            document.getElementById('form-title').textContent = 'Adicionar Novo Contato';

            if (contactId) {
                const contactWrapper = contactsCache.find(c => c.id === contactId);
                if (!contactWrapper) return;
                const contact = contactWrapper.data;
                document.getElementById('form-title').textContent = 'Editar Contato';
                document.getElementById('contact-id').value = contactId;

                const fields = {
                    'form-firstName': contact.firstName, 'form-lastName': contact.lastName, 'form-email': contact.email,
                    'form-phone-fixed': contact.phone?.fixed, 'form-phone-mobile': contact.phone?.mobile,
                    'form-street': contact.address?.street, 'form-number': contact.address?.number, 'form-complement': contact.address?.complement,
                    'form-city': contact.address?.city, 'form-state': contact.address?.state, 'form-zip': contact.address?.zip,
                    'form-website': contact.social?.website, 'form-linkedin': contact.social?.linkedin, 'form-facebook': contact.social?.facebook, 'form-instagram': contact.social?.instagram,
                    'form-anniversary-day': contact.anniversary?.day, 'form-anniversary-month': contact.anniversary?.month,
                    'form-notes': contact.notes
                };
                for (const id in fields) {
                    if (document.getElementById(id) && fields[id]) document.getElementById(id).value = fields[id];
                }
                if (contact.categories) contact.categories.forEach(cat => selectedCategoriesForForm.add(cat));
            }
            
            renderSelectedTags();
            showMainContentView(formView);
        };

        addContactBtn.addEventListener('click', () => showContactForm());
        editContactBtn.addEventListener('click', () => showContactForm(currentContactId));
        
        showBirthdayBtn.addEventListener('click', () => {
            selectedBirthdayMonth = new Date().getMonth() + 1;
            monthFilter.value = selectedBirthdayMonth;
            renderBirthdayList();
            showMainContentView(birthdayView);
        });
        
        showCategoryBtn.addEventListener('click', () => {
            renderCategoryList();
            showMainContentView(categoryView);
        });
        
        importCsvBtn.addEventListener('click', () => {
            importModal.classList.remove('hidden');
            importStatus.textContent = '';
            csvFileInput.value = '';
        });

        importCancelBtn.addEventListener('click', () => importModal.classList.add('hidden'));

        importStartBtn.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) { importStatus.textContent = "Por favor, selecione um arquivo."; return; }
            importStatus.textContent = "A processar...";
            showLoader();
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: async (results) => {
                    const contactsToImport = results.data;
                    importStatus.textContent = `Encontrados ${contactsToImport.length} contatos. A importar...`;
                    const batch = writeBatch(db);
                    contactsToImport.forEach(contact => {
                        const newContactRef = doc(contactsCollection);
                        batch.set(newContactRef, {
                            firstName: contact.primeiroNome || '', lastName: contact.sobrenome || '', email: contact.email || '',
                            phone: { mobile: contact.celular || '', fixed: contact.telefoneFixo || '' },
                            createdAt: serverTimestamp(), updatedAt: serverTimestamp()
                        });
                    });
                    try {
                        await batch.commit();
                        hideLoader();
                        importStatus.textContent = `${contactsToImport.length} contatos importados com sucesso!`;
                        setTimeout(() => importModal.classList.add('hidden'), 2000);
                    } catch (error) {
                        hideLoader();
                        importStatus.textContent = "Erro ao salvar contatos.";
                        console.error("Batch Commit Error:", error);
                    }
                },
                error: (error) => { hideLoader(); importStatus.textContent = "Erro ao ler o arquivo CSV."; console.error("CSV Parse Error:", error); }
            });
        });
        
        monthFilter.addEventListener('change', (e) => {
            selectedBirthdayMonth = parseInt(e.target.value, 10);
            renderBirthdayList();
        });

        contactForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('contact-id').value;
            const day = document.getElementById('form-anniversary-day').value;
            const month = document.getElementById('form-anniversary-month').value;
            const data = {
                firstName: document.getElementById('form-firstName').value.trim(), lastName: document.getElementById('form-lastName').value.trim(),
                email: document.getElementById('form-email').value.trim(), categories: Array.from(selectedCategoriesForForm),
                phone: { fixed: document.getElementById('form-phone-fixed').value.trim(), mobile: document.getElementById('form-phone-mobile').value.trim() },
                address: { street: document.getElementById('form-street').value.trim(), number: document.getElementById('form-number').value.trim(), complement: document.getElementById('form-complement').value.trim(), city: document.getElementById('form-city').value.trim(), state: document.getElementById('form-state').value, zip: document.getElementById('form-zip').value.trim() },
                social: { website: document.getElementById('form-website').value.trim(), linkedin: document.getElementById('form-linkedin').value.trim(), facebook: document.getElementById('form-facebook').value.trim(), instagram: document.getElementById('form-instagram').value.trim() },
                anniversary: { day: day ? parseInt(day, 10) : null, month: month ? parseInt(month, 10) : null },
                notes: document.getElementById('form-notes').value, updatedAt: serverTimestamp()
            };
            if(!id) data.createdAt = serverTimestamp();
            saveContact(id, data);
        });

        cancelFormBtn.addEventListener('click', () => {
            // Se estiver em modo mobile, sempre volta para a lista principal
            if (window.innerWidth <= 768) {
                hideMainContentView();
                return; // Encerra a função aqui para não executar a lógica de desktop
            }

            // Lógica original para desktop
            if (currentContactId) {
                showContactDetails(currentContactId);
            } else {
                showMainContentView(welcomeView);
            }
        });
        
        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = newCategoryNameInput.value.trim();
            if (name) {
                await addDoc(categoriesCollection, { name });
                newCategoryNameInput.value = '';
            }
        });

        categoryList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-category-btn')) {
                itemToDelete.id = e.target.dataset.id;
                itemToDelete.type = 'category';
                deleteModalTitle.textContent = 'Excluir Categoria';
                deleteModalText.textContent = 'Tem certeza que deseja excluir esta categoria? Ela será removida de todos os contatos associados.';
                deleteModal.classList.remove('hidden');
            }
        });
        
        ['form-phone-fixed', 'form-phone-mobile'].forEach(id => document.getElementById(id).addEventListener('input', applyPhoneMask));
        document.getElementById('form-zip').addEventListener('input', applyCepMask);

        deleteContactBtn.addEventListener('click', () => {
            itemToDelete.id = currentContactId;
            itemToDelete.type = 'contact';
            deleteModalTitle.textContent = 'Excluir Contato';
            deleteModalText.textContent = 'Tem certeza que deseja excluir este contato? Esta ação não pode ser desfeita.';
            deleteModal.classList.remove('hidden');
        });
        cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
        confirmDeleteBtn.addEventListener('click', deleteItem);
        
        optimizeNotesBtn.addEventListener('click', async () => {
            const contact = contactsCache.find(c => c.id === currentContactId);
            if (!contact || !contact.data.notes) { alert("Não há notas para otimizar."); return; }
            optimizeNotesBtn.disabled = true;
            optimizeNotesBtn.innerHTML = 'Otimizando...';
            const prompt = `Organize e resuma as seguintes notas sobre um contato profissional. Use bullet points para os pontos chave e formate a informação de forma clara e concisa:\n\n---\n${contact.data.notes}\n---`;
            try {
                const result = await callGeminiFunction({ prompt });
                const optimizedNotes = result.data.text;
                document.getElementById('detail-notes').textContent = optimizedNotes;
                await saveContact(currentContactId, { notes: optimizedNotes });
            } catch (error) {
                console.error("Erro ao chamar a Cloud Function:", error);
                alert("Ocorreu um erro ao contatar a IA. Verifique o console para mais detalhes.");
            } finally {
                optimizeNotesBtn.disabled = false;
                optimizeNotesBtn.innerHTML = '✨ Otimizar';
            }
        });
        
        const handleGenerateMessage = async () => {
            if (!currentContactForGemini) return;
            geminiModalInitialForm.classList.add('hidden');
            geminiModalResult.classList.remove('hidden');
            geminiModalLoader.classList.remove('hidden');
            geminiModalTextarea.value = '';
            const relationship = document.getElementById('gemini-relationship').value;
            const tone = document.getElementById('gemini-tone').value;
            const nickname = document.getElementById('gemini-nickname').value.trim();
            const contactName = `${currentContactForGemini.data.firstName || ''} ${currentContactForGemini.data.lastName || ''}`.trim();
            const notes = currentContactForGemini.data.notes || 'Nenhuma nota adicional.';
            lastGeminiPrompt = `Crie uma mensagem de aniversário para ${contactName}. O nosso relacionamento é de ${relationship}. O tom da mensagem deve ser ${tone}. ${nickname ? `Pode usar o apelido '${nickname}'.` : ''} Leve também em consideração estas notas sobre o nosso relacionamento: "${notes}".`;
            try {
                const result = await callGeminiFunction({ prompt: lastGeminiPrompt });
                geminiModalTextarea.value = result.data.text;
            } catch (error) {
                console.error("Erro ao chamar a Cloud Function:", error);
                geminiModalTextarea.value = "Ocorreu um erro ao contatar a IA. Verifique o console para mais detalhes.";
            } finally {
                geminiModalLoader.classList.add('hidden');
            }
        };
        
        geminiModalGenerateBtn.addEventListener('click', handleGenerateMessage);
        geminiModalRegenerateBtn.addEventListener('click', handleGenerateMessage);

        birthdayList.addEventListener('click', (e) => {
            const target = e.target.closest('.generate-msg-btn');
            if (target) {
                currentContactForGemini = contactsCache.find(c => c.id === target.dataset.contactId);
                if (!currentContactForGemini) return;
                geminiModal.classList.remove('hidden');
                geminiModalInitialForm.classList.remove('hidden');
                geminiModalResult.classList.add('hidden');
                geminiModalInitialForm.querySelector('form')?.reset();
            }
        });
        
        geminiModalCancelBtn.addEventListener('click', () => {
            geminiModal.classList.add('hidden');
        });

        geminiModalCloseBtn.addEventListener('click', () => geminiModal.classList.add('hidden'));
        
        geminiModalCopyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(geminiModalTextarea.value).then(() => {
                geminiModalCopyBtn.textContent = 'Copiado!';
                setTimeout(() => { geminiModalCopyBtn.textContent = 'Copiar'; }, 2000);
            }).catch(err => console.error('Falha ao copiar: ', err));
        });

        geminiModalSendBtn.addEventListener('click', () => {
            if (currentContactForGemini?.data.phone?.mobile) {
                const mobileNumber = currentContactForGemini.data.phone.mobile.replace(/\D/g, '');
                const message = encodeURIComponent(geminiModalTextarea.value);
                window.open(`https://wa.me/55${mobileNumber}?text=${message}`, '_blank');
            }
        });
        
        const renderSelectedTags = () => {
            tagInputContainer.querySelectorAll('.tag-input-tag').forEach(tag => tag.remove());
            selectedCategoriesForForm.forEach(categoryName => {
                const tag = document.createElement('div');
                tag.className = 'tag-input-tag';
                tag.textContent = categoryName;
                const removeBtn = document.createElement('span');
                removeBtn.className = 'tag-input-remove';
                removeBtn.textContent = 'x';
                removeBtn.onclick = () => {
                    selectedCategoriesForForm.delete(categoryName);
                    renderSelectedTags();
                };
                tag.appendChild(removeBtn);
                tagInputContainer.prepend(tag);
            });
        };

        tagInputField.addEventListener('input', () => {
            const inputText = tagInputField.value.toLowerCase();
            tagInputSuggestions.innerHTML = '';
            if (inputText.length === 0) { tagInputSuggestions.classList.add('hidden'); return; }
            const suggestions = categoriesCache.map(c => c.data.name).filter(name => name.toLowerCase().includes(inputText) && !selectedCategoriesForForm.has(name));
            if (suggestions.length > 0) {
                suggestions.forEach(suggestion => {
                    const el = createAndAppend(tagInputSuggestions, 'div', { text: suggestion, classes: ['tag-input-suggestion'] });
                    el.onclick = () => {
                        selectedCategoriesForForm.add(suggestion);
                        renderSelectedTags();
                        tagInputField.value = '';
                        tagInputSuggestions.classList.add('hidden');
                        tagInputField.focus();
                    };
                });
                tagInputSuggestions.classList.remove('hidden');
            } else {
                tagInputSuggestions.classList.add('hidden');
            }
        });
        
        tagInputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const newCategoryName = tagInputField.value.trim();
                if (newCategoryName && !selectedCategoriesForForm.has(newCategoryName)) {
                    selectedCategoriesForForm.add(newCategoryName);
                    renderSelectedTags();
                    tagInputField.value = '';
                    tagInputSuggestions.classList.add('hidden');
                }
            }
        });

        document.addEventListener('click', (e) => {
            if (!tagInputContainer.contains(e.target)) tagInputSuggestions.classList.add('hidden');
        });

        document.querySelectorAll('.back-to-list-btn').forEach(btn => btn.addEventListener('click', hideMainContentView));
        
        document.querySelectorAll('.password-toggle-icon').forEach(icon => {
            icon.addEventListener('click', () => {
                const passwordInput = document.getElementById(icon.dataset.target);
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                icon.querySelector('.eye-icon').classList.toggle('hidden', isPassword);
                icon.querySelector('.eye-off-icon').classList.toggle('hidden', !isPassword);
            });
        });
        
        settingsBtn.addEventListener('click', () => {
            const isHidden = settingsSubmenu.classList.toggle('hidden');
            settingsArrow.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
        });
        
        changePasswordBtn.addEventListener('click', () => {
            showMainContentView(changePasswordView);
            changePasswordForm.reset();
            changePasswordMessage.textContent = '';
        });
        
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const user = auth.currentUser;
            if (!user) return;
            showLoader();
            changePasswordMessage.textContent = '';
            changePasswordMessage.classList.remove('success-message', 'error-message');
            try {
                await reauthenticateWithCredential(user, EmailAuthProvider.credential(user.email, currentPassword));
                await updatePassword(user, newPassword);
                changePasswordMessage.textContent = 'Senha alterada com sucesso!';
                changePasswordMessage.classList.add('success-message');
                changePasswordForm.reset();
            } catch (error) {
                changePasswordMessage.textContent = "Senha atual incorreta. Tente novamente.";
                changePasswordMessage.classList.add('error-message');
            } finally {
                hideLoader();
            }
        });
        
        const applyTheme = (theme) => {
            document.body.className = theme;
            localStorage.setItem('agenda-theme', theme);
            const isDark = theme === 'dark-theme';
            themeIconSun.classList.toggle('hidden', isDark);
            themeIconMoon.classList.toggle('hidden', !isDark);
        };

        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.body.className === 'light-theme' ? 'dark-theme' : 'light-theme';
            applyTheme(newTheme);
        });
        
        const handleResize = () => {
            if (window.innerWidth > 768) {
                mainContent.classList.remove('visible');
                sidebar.classList.remove('has-selection');
                showMainContentView(welcomeView); // Mostra a welcome view se a tela for redimensionada para desktop
            }
        };
        window.addEventListener('resize', handleResize);
        
        // --- INICIALIZAÇÃO ---
        const init = () => {
            populateStates();
            populateAnniversarySelectors();
            populateMonthFilter();
            const savedTheme = localStorage.getItem('agenda-theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark-theme' : 'light-theme');
            applyTheme(savedTheme);
            showLoader();
        };

        init();
    </script>
</body>
</html>